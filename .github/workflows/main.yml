name: ðŸš€ Automation Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  hospitalizacion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install

      - uses: browser-actions/setup-edge@v1

      - name: ðŸ§ª Run Hospitalizacion
        run: npm run test:hospitalizacion
        env:
          SF_PRIVATE_KEY: ${{ secrets.SF_PRIVATE_KEY }}

      - name: ðŸ“¦ Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-hospitalizacion
          path: allure-results


  externo:
    runs-on: ubuntu-latest
    needs:
    - hospitalizacion
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - uses: browser-actions/setup-edge@v1

      - name: ðŸ§ª Run Externo
        run: npm run test:externo
        env:
          SF_PRIVATE_KEY: ${{ secrets.SF_PRIVATE_KEY }}

      - name: ðŸ“¦ Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-externo
          path: allure-results


  cuentasexterno:
    runs-on: ubuntu-latest
    needs:
    - hospitalizacion
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - uses: browser-actions/setup-edge@v1

      - name: ðŸ§ª Run Cuentas Externo
        run: npm run test:cuentasexterno
        env:
          SF_PRIVATE_KEY: ${{ secrets.SF_PRIVATE_KEY }}

      - name: ðŸ“¦ Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-cuentasexterno
          path: allure-results

  valoracion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - uses: browser-actions/setup-edge@v1

      - name: ðŸ§ª Run Valoracion
        run: npm run test:valoracion
        env:
          SF_PRIVATE_KEY: ${{ secrets.SF_PRIVATE_KEY }}

      - name: ðŸ“¦ Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-valoracion
          path: allure-results

  generate-report:
    runs-on: ubuntu-latest
    needs:
    - hospitalizacion
    - externo
    - cuentasexterno
#    - valoracion
    if: always()
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install

      - name: ðŸ“¥ Download all results
        uses: actions/download-artifact@v4
        with:
          path: merged-results

      - name: ðŸ”€ Merge Allure Results
        run: |
          mkdir allure-results
          find merged-results -type f -name "*.json" -exec cp {} allure-results/ \;

      - name: ðŸ“Š Generate Single Page Report
        run: npx allure generate allure-results --clean -o allure-report --single-file

      - name: ðŸ“¤ Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-final
          path: allure-report
